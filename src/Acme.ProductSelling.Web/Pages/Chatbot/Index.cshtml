@page "/chat"
@model Acme.ProductSelling.Web.Pages.Chatbot.IndexModel
@{
    ViewData["Title"] = L["UI:Titles:Chat"];
    Layout = "/Views/Shared/_Layout.cshtml";
}

<style>
    /* Custom CSS to fix the 'Ugly' scrolling behavior */
    .chat-container {
        height: 80vh; /* Fixed height relative to viewport */
        display: flex;
        flex-direction: column;
    }

    .chat-card {
        height: 100%;
        display: flex;
        flex-direction: column;
        border-radius: 12px;
        border: none;
    }

    .chat-header {
        flex-shrink: 0; /* Header stays fixed size */
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
    }

    .chat-body {
        flex-grow: 1; /* Takes up all available space */
        overflow-y: auto; /* Internal scrolling only */
        background-color: #f8f9fa;
        padding: 20px;
    }

    .chat-footer {
        flex-shrink: 0; /* Footer stays fixed size */
        background-color: white;
        border-top: 1px solid #dee2e6;
        border-bottom-left-radius: 12px !important;
        border-bottom-right-radius: 12px !important;
    }

    .message-bubble {
        max-width: 80%;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
</style>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 chat-container">
            <div class="card shadow chat-card">

                <!-- Header -->
                <div class="card-header bg-primary text-white chat-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        AI Shopping Assistant
                    </h5>
                    <span id="userRoleBadge" class="badge bg-white text-primary">Guest</span>
                </div>

                <!-- Scrollable Area -->
                <div class="chat-body" id="chatMessages">
                    <!-- Welcome Message -->
                    <div class="d-flex justify-content-start mb-3">
                        <div class="bg-white p-3 rounded message-bubble">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Welcome! Ask me about products, specs, or availability.
                        </div>
                    </div>
                </div>

                <!-- Footer / Input -->
                <div class="card-footer chat-footer p-3">

                    <!-- Quick Actions Scroller -->
                    <div class="mb-3 d-flex gap-2 overflow-auto" style="scrollbar-width: thin;">
                        <button class="btn btn-sm btn-outline-secondary rounded-pill text-nowrap quick-question" data-question="Gaming Laptops">Gaming Laptops</button>
                        <button class="btn btn-sm btn-outline-secondary rounded-pill text-nowrap quick-question" data-question="Cheapest Mouse">Cheapest Mouse</button>
                        <button class="btn btn-sm btn-outline-secondary rounded-pill text-nowrap quick-question" data-question="Stock Status">Stock Check</button>
                    </div>

                    <form id="chatForm">
                        <div class="input-group">
                            <input type="text"
                                   id="messageInput"
                                   class="form-control border-end-0"
                                   placeholder="Type a message..."
                                   autocomplete="off"
                                   required>
                            <button type="submit" class="btn btn-primary" id="sendButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            const chatMessages = $('#chatMessages');
            const messageInput = $('#messageInput');
            const sendButton = $('#sendButton');
            const chatForm = $('#chatForm');
            const userRoleBadge = $('#userRoleBadge');

            let conversationHistory = [];

            // --- Event Handlers ---

            chatForm.on('submit', function(e) {
                e.preventDefault();
                const message = messageInput.val().trim();
                if (message) {
                    sendMessage(message);
                    messageInput.val('');
                }
            });

            $('.quick-question').on('click', function() {
                const question = $(this).data('question');
                sendMessage(question);
            });

            // --- Main Logic ---

            function sendMessage(message) {
                addMessageToChat('user', message);
                const loadingId = showLoading();
                toggleInput(false);

                const requestData = {
                    message: message,
                    conversationHistory: conversationHistory
                };

                abp.ajax({
                    url: '/api/app/chatbot/send-message',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData)
                }).then(function(response) {
                    removeLoading(loadingId);

                    // 1. Add Text Response
                    addMessageToChat('assistant', response.response);

                    // 2. Render Products INSIDE the stream immediately after the text
                    if (response.relatedProducts && response.relatedProducts.length > 0) {
                        renderProductGrid(response.relatedProducts);
                    }

                    // 3. Update History & Role
                    conversationHistory.push({ role: 'user', content: message, timestamp: new Date().toISOString() });
                    conversationHistory.push({ role: 'assistant', content: response.response, timestamp: new Date().toISOString() });
                    if (conversationHistory.length > 10) conversationHistory = conversationHistory.slice(-10);

                    updateRoleBadge(response.userRole);

                }).catch(function(err){
                    removeLoading(loadingId);
                    addMessageToChat('system', 'Sorry, I encountered an error. Please try again.');
                    console.error(err);
                }).always(function() {
                    toggleInput(true);
                    messageInput.focus();
                });
            }

            // --- UI Helper Functions ---

            function addMessageToChat(role, content) {
                const isUser = role === 'user';
                const alignClass = isUser ? 'justify-content-end' : 'justify-content-start';
                const bubbleClass = isUser ? 'bg-primary text-white' : 'bg-white border';
                const errorClass = role === 'system' ? 'bg-danger text-white' : '';

                // Format Markdown logic
                const formattedContent = formatMessageText(content);

                const html = `
                    <div class="d-flex ${alignClass} mb-3">
                        <div class="p-3 rounded message-bubble ${bubbleClass} ${errorClass}">
                            ${formattedContent}
                        </div>
                    </div>
                `;

                chatMessages.append(html);
                scrollToBottom();
            }

            function renderProductGrid(products) {
                let cardsHtml = '';

                products.forEach(p => {
                    const price = p.discountedPrice || p.originalPrice;
                    const img = p.imageUrl || 'https://placehold.co/400x300?text=No+Img';

                    cardsHtml += `
                        <div class="col" style="min-width: 160px;"> <!-- Min-width ensures grid look -->
                            <div class="card h-100 shadow-sm border-0" style="font-size: 0.9em;">
                                <img src="${img}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                <div class="card-body p-2">
                                    <h6 class="text-truncate mb-1" title="${p.productName}">${p.productName}</h6>
                                    <div class="fw-bold text-primary mb-2">$${price.toLocaleString()}</div>
                                    <a href="/products/${p.urlSlug}" target="_blank" class="btn btn-xs btn-outline-primary w-100">View</a>
                                </div>
                            </div>
                        </div>
                    `;
                });

                const containerHtml = `
                    <div class="d-flex justify-content-start mb-3">
                         <div class="p-3 bg-light rounded w-100 border">
                             <small class="text-muted mb-2 d-block fw-bold">Found Products:</small>
                             <div class="row row-cols-2 row-cols-md-3 g-2">
                                ${cardsHtml}
                             </div>
                         </div>
                    </div>
                `;

                chatMessages.append(containerHtml);
                scrollToBottom();
            }

            function formatMessageText(text) {
                let safeText = $('<div>').text(text).html();
                return safeText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/^- (.*)/gm, '<li>$1</li>')
                    .replace(/\n/g, '<br>');
            }

            function scrollToBottom() {
                // Use Timeout to wait for image rendering/DOM painting
                setTimeout(() => {
                    chatMessages.animate({ scrollTop: chatMessages[0].scrollHeight }, 300);
                }, 50);
            }

            function showLoading() {
                const id = 'load-' + Date.now();
                const html = `
                    <div id="${id}" class="d-flex justify-content-start mb-3">
                        <div class="bg-light p-2 px-3 rounded text-muted small">
                            <span class="spinner-grow spinner-grow-sm me-1" role="status" aria-hidden="true"></span>
                            Thinking...
                        </div>
                    </div>`;
                chatMessages.append(html);
                scrollToBottom();
                return id;
            }

            function removeLoading(id) { $('#' + id).remove(); }

            function toggleInput(enabled) {
                messageInput.prop('disabled', !enabled);
                sendButton.prop('disabled', !enabled);
            }

            function updateRoleBadge(role) {
                 const names = { 'admin': 'Admin', 'staff': 'Staff', 'customer': 'Customer' };
                 userRoleBadge.text(names[role] || 'Guest');
            }
        });
    </script>
}