@page "/Orders/Details/{id:Guid}"
@using Acme.ProductSelling.Orders.Dtos
@model Acme.ProductSelling.Web.Pages.Orders.OrderDetailModel
@using System.Globalization

@{
    ViewData["Title"] = L["UI:Title:OrderDetails"];
    Layout = "/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <!-- Alert Container -->
    <div id="alert-container" style="display: none;">
        <div class="alert alert-dismissible fade show" role="alert" id="alert-message">
            <span id="alert-text"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <abp-card>
        <abp-card-header>
            <abp-row>
                <abp-column size-md="_6">
                    <h2>@L["Order:Details"]</h2>
                </abp-column>
                <abp-column size-md="_6" class="text-end">
                    <a href="@Url.Page("/Orders/OrderHistory")" class="btn btn-secondary">
                        <i class="fa fa-arrow-left"></i> @L["Order:BackToOrderHistory"]
                    </a>
                </abp-column>
            </abp-row>
        </abp-card-header>
        <abp-card-body>
            @if (Model.Order != null)
            {
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h4>@L["Order:OrderInformation"]</h4>
                        <table class="table table-borderless" style="table-layout: fixed;">
                            <tr>
                                <th>@L["Order:Number"]:</th>
                                <td><span id="display-order-number">@Model.Order.OrderNumber</span></td>
                            </tr>
                            <tr>
                                <th>@L["Order:OrderDate"]:</th>
                                <td>@Model.Order.OrderDate.ToString("g")</td>
                            </tr>
                            <tr>
                                <th>@L["Order:OrderStatus"]:</th>
                                <td>
                                    @* FIX: Used Html.Raw to render symbols like Đ correctly *@
                                    <span class="badge @(Model.GetOrderStatusBadgeClass(Model.Order.OrderStatus)) text-white"
                                          id="orderStatusBadge">
                                        @Html.Raw(L[$"Enum:OrderStatus.{Model.Order.OrderStatus}"])
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>@L["Order:PaymentStatus"]:</th>
                                <td>
                                    @* FIX: Used Html.Raw *@
                                    <span class="badge @(Model.GetPaymentStatusBadgeClass(Model.Order.PaymentStatus)) text-white"
                                          id="paymentStatusBadge">
                                        @Html.Raw(L[$"Enum:PaymentStatus.{Model.Order.PaymentStatus}"])
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>@L["Order:TotalAmount"]:</th>
                                <td>
                                    @(Model.Order.TotalAmount.ToString("C0", CultureInfo.GetCultureInfo("vi-VN")))
                                </td>
                            </tr>
                            <tr>
                                <th>@L["Order:PaymentMethod"]:</th>
                                <td>@L[$"Enum:PaymentMethod:{Model.Order.PaymentMethod}"]</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>@L["Order:CustomerInformation"]</h4>
                        <table class="table table-borderless th-middle" style="table-layout: fixed;">
                            <tr>
                                <th>@L["Order:CustomerName"]:</th>
                                <td>@Model.Order.CustomerName</td>
                            </tr>

                            <tr>
                                <th>@L["Order:PhoneNumber"]:</th>
                                <td>@Model.Order.CustomerPhone</td>
                            </tr>
                            <tr>
                                <th>@L["Order:ShippingAddress"]:</th>
                                <td>@Model.Order.ShippingAddress</td>
                            </tr>
                        </table>

                        @* LOGIC UPDATE: Switch from FORM to AJAX Button *@
                        @if (Model.Order.OrderStatus == Acme.ProductSelling.Orders.OrderStatus.Placed ||
                                            Model.Order.OrderStatus == Acme.ProductSelling.Orders.OrderStatus.Pending)
                        {
                            <div id="cancelOrderContainer" class="mt-3">
                                <div class="alert alert-info d-flex justify-content-between align-items-center">
                                    <span>@L["Order:YouCanCancel"]</span>
                                    <button type="button"
                                            class="btn btn-danger btn-cancel-order"
                                            data-order-id="@Model.Order.Id"
                                            data-order-number="@Model.Order.OrderNumber">
                                        <i class="fa fa-times"></i> @L["Order:Cancel"]
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <h4>@L["Order:OrderItems"]</h4>
                <abp-table striped-rows="true">
                    <thead>
                        <tr>
                            <th>@L["Order:Product"]</th>
                            <th>@L["Order:UnitPrice"]</th>
                            <th>@L["Order:Quantity"]</th>
                            <th>@L["Order:Subtotal"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Order.OrderItems)
                        {
                            <tr>
                                <td>@item.ProductName</td>
                                <td>@item.Price.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))</td>
                                <td>@item.Quantity</td>
                                <td>
                                    @((item.Price * item.Quantity).ToString("C0", CultureInfo.GetCultureInfo("vi-VN")))
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end"><strong>@L["Order:Total"]:</strong></td>
                            <td><strong>@Model.Order.TotalAmount.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))</strong></td>
                        </tr>
                    </tfoot>
                </abp-table>

            }
            else
            {
                <div class="alert alert-warning">
                    @L["Order:OrderNotFound"]
                </div>
            }
        </abp-card-body>
    </abp-card>

    <abp-card class="mt-3">
        <abp-card-header>
            <abp-card-title>
                <i class="bi bi-clock-history me-2"></i>
                @L["Order:OrderHistory"]
            </abp-card-title>
        </abp-card-header>
        <abp-card-body>
            @if (Model.OrderHistory != null && Model.OrderHistory.Any())
            {
                <div class="timeline">
                    @foreach (var history in Model.OrderHistory)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker @GetHistoryMarkerClass(history)"></div>
                            <div class="timeline-content">
                                <div class="d-flex gap-3 align-items-start">
                                    <div>
                                        <h6 class="mb-1">@history.ChangeDescription</h6>
                                        <p class="text-muted mb-1">
                                            <i class="bi bi-person me-1"></i>
                                            <strong>@history.ChangedBy</strong>
                                        </p>
                                        <p class="text-muted mb-1">
                                            <i class="bi bi-clock me-1"></i>
                                            @history.CreationTime.ToString("dd/MM/yyyy HH:mm:ss")
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        @if (history.OldStatus != history.NewStatus)
                                        {
                                            <div class="mb-2">
                                                <small class="text-muted d-block">@L["Order:OrderStatus"]</small>
                                                <span class="badge @Model.GetOrderStatusBadgeClass(history.OldStatus) text-white">
                                                    @Html.Raw(L[$"Enum:OrderStatus.{history.OldStatus}"])
                                                </span>
                                                <i class="bi bi-arrow-right mx-1"></i>
                                                <span class="badge @Model.GetOrderStatusBadgeClass(history.NewStatus) text-white">
                                                    @Html.Raw(L[$"Enum:OrderStatus.{history.NewStatus}"])
                                                </span>
                                            </div>
                                        }
                                        @if (history.OldPaymentStatus != history.NewPaymentStatus)
                                        {
                                            <div>
                                                <small class="text-muted d-block">Payment Status:</small>
                                                <span class="badge @Model.GetPaymentStatusBadgeClass(history.OldPaymentStatus) text-white">
                                                    @Html.Raw(L[$"Enum:PaymentStatus.{history.OldPaymentStatus}"])
                                                </span>
                                                <i class="bi bi-arrow-right mx-1"></i>
                                                <span class="badge @Model.GetPaymentStatusBadgeClass(history.NewPaymentStatus) text-white">
                                                    @Html.Raw(L[$"Enum:PaymentStatus.{history.NewPaymentStatus}"])
                                                </span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    @L["Order:NoHistoryAvailable"]
                </div>
            }
        </abp-card-body>
    </abp-card>

</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@L["Order:ConfirmCancellation"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>@L["Order:AreYouSureYouWantToCancelOrder"]</p>
                <p><strong>@L["Order:Number"]:</strong> <span id="cancel-order-number"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@L["No"]</button>
                <button type="button" class="btn btn-danger" id="confirm-cancel-btn">
                    <span class="btn-text">@L["Yes:Cancel"]</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetHistoryMarkerClass(OrderHistoryDto history)
    {
        if (history.NewStatus == "Delivered") return "bg-success";
        if (history.NewStatus == "Shipped") return "bg-primary";
        if (history.NewStatus == "Cancelled") return "bg-danger";
        if (history.NewPaymentStatus == "Paid") return "bg-success";
        if (history.NewPaymentStatus == "Failed") return "bg-danger";
        return "bg-info";
    }
}

@section styles {
    <style>
        .th-middle th {
            vertical-align: middle !important;
        }
    </style>
    <link href="~/css/shared/order-timeline.css" rel="stylesheet" />
}

@section scripts {
    <abp-script-bundle name="Shared.Order.SignalR" />
    <script>
        $(document).ready(function() {
            let currentOrderId = null;
            const cancelModal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));

            // Show alert function
            function showAlert(message, type = 'success') {
                const alertContainer = $('#alert-container');
                const alertMessage = $('#alert-message');
                const alertText = $('#alert-text');

                alertMessage.removeClass('alert-success alert-danger alert-warning alert-info');
                alertMessage.addClass(`alert-${type}`);
                alertText.text(message);
                alertContainer.fadeIn();

                setTimeout(() => { alertContainer.fadeOut(); }, 5000);
                $('html, body').animate({ scrollTop: 0 }, 300);
            }

            // Open cancel modal
            $(document).on('click', '.btn-cancel-order', function(e) {
                e.preventDefault();
                currentOrderId = $(this).data('order-id');
                const orderNumber = $(this).data('order-number');

                $('#cancel-order-number').text(orderNumber);
                cancelModal.show();
            });

            // Confirm cancellation via AJAX
            $('#confirm-cancel-btn').on('click', async function() {
                if (!currentOrderId) return;

                const btn = $(this);
                const btnText = btn.find('.btn-text');
                const spinner = btn.find('.spinner-border');
                const modalCloseBtn = $('.modal-footer .btn-secondary');

                // UI: Loading state
                btn.prop('disabled', true);
                modalCloseBtn.prop('disabled', true);
                btnText.addClass('d-none');
                spinner.removeClass('d-none');

                try {
                    // Note: Ensure your PageModel has OnPostCancelOrderAjaxAsync method
                    const response = await fetch('?handler=CancelOrderAjax', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        body: JSON.stringify({ orderId: currentOrderId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Success Logic for Detail Page:

                        // 1. Update Badge
                        $('#orderStatusBadge')
                            .removeClass('bg-primary bg-warning bg-info bg-success')
                            .addClass('bg-danger')
                            .html('@Html.Raw(L["Enum:OrderStatus.Cancelled"])');

                        // 2. Remove Cancel Option
                        $('#cancelOrderContainer').remove();

                        // 3. Show Success
                        showAlert(data.message, 'success');
                        cancelModal.hide();

                        // Optional: Reload after 1.5 seconds to refresh Timeline
                        setTimeout(() => location.reload(), 1500);

                    } else {
                        showAlert(data.message, 'danger');
                    }
                } catch (error) {
                    console.error('[CancelOrder] ERROR:', error);
                    showAlert('@L["Error:GeneralError"]', 'danger');
                } finally {
                    // Reset UI
                    btn.prop('disabled', false);
                    modalCloseBtn.prop('disabled', false);
                    btnText.removeClass('d-none');
                    spinner.addClass('d-none');
                    currentOrderId = null;
                }
            });
        });
    </script>
}