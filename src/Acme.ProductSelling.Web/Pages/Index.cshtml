@page "/"
@using Acme.ProductSelling.Web.Pages.Components.Home.HeroSection
@using Acme.ProductSelling.Web.Pages.Components.Home.CategoryList
@using Acme.ProductSelling.Web.Pages.Components.RecentlyViewed
@inject ICurrentUser CurrentUser
@model Acme.ProductSelling.Web.Pages.IndexModel

@section styles {
    <abp-style src="/Pages/Index.css" />
    <link href="~/css/shared/products/product-item.css" rel="stylesheet" />
    <link href="~/css/global/products/recently-viewed.css" rel="stylesheet" />

}

@section scripts {
    <abp-script src="/Pages/Index.js" />

    <script>
        RecentlyViewedManager.loadWidget('my-recently-viewed-container');
    </script>
}

@{
    ViewData["Title"] = L["Menu:AppName"];
    Layout = "/Views/Shared/_Layout.cshtml";
}

<div class="container p-0">
    <div class="row">
        <div class="col-md-12 d-flex flex-column gap-1">
            @await Component.InvokeAsync(typeof(HeroSectionViewComponent))

            @if (Model.FeaturedProductCarousels != null && Model.FeaturedProductCarousels.Any())
            {
                foreach (var featuredCategory in Model.FeaturedProductCarousels)
                {
                    if (featuredCategory.Products == null || !featuredCategory.Products.Any())
                    {
                        continue;
                    }

                    var carouselId = $"carousel_{featuredCategory.Category.Id.ToString().Replace("-", "")}";
                    <section class="container my-3 bg-light rounded py-3">
                        <div class="d-flex justify-content-between align-items-center pb-2 mb-3 ps-2">
                            <h2 class="m-0 h4">
                                @L["UI:ProductsFromCategory"] @HelperMethods.GetCategoryLocalizerName(featuredCategory.Category.Name, L)
                            </h2>
                            <a asp-page="/Products/ProductsByCategory"
                               asp-route-slug="@featuredCategory.Category.UrlSlug"
                               class="btn btn-sm btn-outline-primary">
                                @L["SeeAll"] <i class="bi bi-arrow-right-short"></i>
                            </a>
                        </div>

                        <div class="product-carousel-wrapper">
                            <div id="@carouselId" class="product-carousel-container">
                                <button class="carousel-control-custom carousel-control-prev-custom" type="button">
                                    <i class="bi bi-chevron-left"></i>
                                </button>

                                <div class="product-carousel-track">
                                    @foreach (var product in featuredCategory.Products)
                                    {
                                        <div class="product-carousel-item">
                                            <div class="card product-card shadow-sm">
                                                @if (!string.IsNullOrWhiteSpace(product.ImageUrl))
                                                {
                                                    <a asp-page="/Products/ProductDetail" asp-route-slug="@product.UrlSlug">
                                                        <img src="@($"https://placehold.co/200x200?text={product.ProductName.Substring(0, 1)}")"
                                                             class="card-img-top p-3"
                                                             loading="lazy"
                                                             alt="@product.ProductName"
                                                             style="max-height: 180px; object-fit: contain;">
                                                    </a>
                                                }
                                                else
                                                {
                                                    <div class="text-center p-5 bg-light">
                                                        <i class="fas fa-image fa-3x text-secondary"></i>
                                                    </div>
                                                }

                                                <div class="card-body d-flex flex-column">
                                                    <div class="product-header mb-2">
                                                        <h6 class="card-title mb-1 fs-6" style="min-height: 40px;">
                                                            <a asp-page="/Products/ProductDetail"
                                                               class="text-decoration-none text-dark"
                                                               asp-route-slug="@product.UrlSlug"
                                                               title="@product.ProductName">
                                                                @(product.ProductName.Length > 50 ? product.ProductName.Substring(0, 47) + "..." : product.ProductName)
                                                            </a>
                                                        </h6>
                                                    </div>

                                                    @if (product.DiscountPercent > 0)
                                                    {
                                                        <div class="card-text mt-auto">
                                                            <div class="text-muted text-decoration-line-through small mb-0">
                                                                @product.OriginalPrice.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                                                            </div>
                                                            <div class="d-flex align-items-center gap-2">
                                                                <span class="fw-bold fs-6 text-danger">
                                                                    @product.DiscountedPrice.Value.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                                                                </span>
                                                                <span class="badge bg-danger small">-@product.DiscountPercent%</span>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="mt-auto fw-bold text-danger fs-6">
                                                            @product.OriginalPrice.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                                                        </div>
                                                    }
                                                </div>

                                                <div class="card-footer bg-transparent border-0 text-center pb-2">
                                                    <a asp-page="/Products/ProductDetail"
                                                       asp-route-slug="@product.UrlSlug"
                                                       class="btn btn-sm btn-primary w-100">
                                                        @L["ViewDetails"]
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>

                                <button class="carousel-control-custom carousel-control-next-custom" type="button">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </section>
                }
            }
            else
            {
                <section class="container my-2 bg-light rounded py-3">
                    <div class="alert alert-info">@L["Product:NoFeaturedProductsFound"]</div>
                </section>
            }


            <div class="recently-viewed-wrapper" style="display: none;">
                <section class="container my-3 bg-light rounded py-3">
                    <div class="d-flex justify-content-between align-items-center pb-2 mb-3 ps-2">
                        <h2 class="m-0 h4">@L["UI:RecentlyViewed"]</h2>
                       
                    </div>

                    <div id="my-recently-viewed-container">
                        <div class="text-center p-4 text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i> Loading...
                        </div>
                    </div>
                </section>
            </div>
            @await Component.InvokeAsync(typeof(CategoryListViewComponent))

            @await Component.InvokeAsync(typeof(RecentlyViewedViewComponent),
                                        new { maxCount = 6, title = L["UI:RecentlyViewed"].Value, })
            
        </div>
    </div>
</div>