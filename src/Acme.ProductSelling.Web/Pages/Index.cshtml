@page "/"
@using Acme.ProductSelling.Web.Pages.Components.Home.HeroSection
@using Acme.ProductSelling.Web.Pages.Components.Home.CategoryList
@inject ICurrentUser CurrentUser
@model Acme.ProductSelling.Web.Pages.IndexModel

@section styles {
    <abp-style src="/Pages/Index.css" />
}
@section scripts {
    <abp-script src="/Pages/Index.js" />
}

@{
    ViewData["Title"] = L["Menu:AppName"];
    Layout = "/Views/Shared/_Layout.cshtml";
    int productsPerSlide = 4;
}

@functions {
}


<div class="container p-0">
    <div class="row">
        <div class="col-md-12 d-flex flex-column gap-1 ">
            @* <vc:hero-section /> *@
            @await Component.InvokeAsync(typeof(HeroSectionViewComponent))
            @if (Model.FeaturedProductCarousels != null && Model.FeaturedProductCarousels.Any())
            {
                foreach (var featuredCategory in Model.FeaturedProductCarousels)
                {
                    if (featuredCategory.Products == null || !featuredCategory.Products.Any())
                    {
                        continue;
                    }
                    var carouselId = $"categoryCarousel_{featuredCategory.Category.Id.ToString().Replace("-", "")}";
                    <section class="container my-3 bg-light rounded py-3 product-carousel">
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3 ps-2">

                            <h2 class="m-0">@L["UI:ProductsFromCategory"] @HelperMethods.GetCategoryLocalizerName(featuredCategory.Category.Name, L)</h2>
                            <a asp-page="/Products/ProductsByCategory"
                               asp-route-slug="@featuredCategory.Category.UrlSlug"
                               class="btn btn-sm btn-outline-primary">@L["SeeAll"] <i class="bi bi-arrow-right-short"></i></a>
                        </div>

                        <div id="@carouselId" class="carousel slide" data-bs-ride="false">
                            <div class="carousel-inner">
                                @for (int i = 0; i < featuredCategory.Products.Count; i += productsPerSlide)
                                {
                                    var slideProducts = featuredCategory.Products.Skip(i).Take(productsPerSlide).ToList();
                                    <div class="carousel-item @(i == 0 ? "active" : "")">
                                        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-@productsPerSlide g-3 px-1">
                                            @foreach (var product in slideProducts)
                                            {
                                                <div class="col col-carousel">
                                                    <div class="card h-100 shadow-sm">
                                                        @if (!string.IsNullOrWhiteSpace(product.ImageUrl))
                                                        {
                                                            <a asp-page="/Products/ProductDetail" asp-route-slug="@product.UrlSlug">
                                                                <img src="@($"https://placehold.co/80x80?text={product.ProductName.Substring(0, 1)}")"
                                                                     class="card-img-top p-3"
                                                                     loading="lazy"
                                                                     alt="@product.ProductName"
                                                                     style="max-height: 180px; object-fit: contain;">
                                                            </a>
                                                        }
                                                        else
                                                        {
                                                            <div class="text-center p-5 bg-light">
                                                                <i class="fas fa-image fa-3x text-secondary">

                                                                </i>
                                                            </div>
                                                        }
                                                        <div class="card-body d-flex flex-column ">
                                                            <div class="product-header mb-2">
                                                                <h6 class="card-title mb-1 fs-6" style="min-height: 40px;">
                                                                    <a asp-page="/Products/ProductDetail" class="text-decoration-none"
                                                                       asp-route-slug="@product.UrlSlug" title="@product.ProductName">
                                                                        @(product.ProductName.Length > 50 ? product.ProductName.Substring(0, 47) + "..." : product.ProductName)
                                                                    </a>
                                                                </h6>
                                                            </div>
                                                            @if (product.DiscountPercent > 0 || product.DiscountedPrice != null)
                                                            {
                                                                <div class="card-text mt-auto">
                                                                    <div class="text-muted text-decoration-line-through small mb-0">
                                                                        @product.OriginalPrice.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                                                                    </div>
                                                                    <div class="d-flex align-items-center gap-2">
                                                                        <span class="fw-bold fs-6 text-danger">
                                                                            @product.DiscountedPrice.Value.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                                                                        </span>
                                                                        <span class="badge bg-danger small">-@product.DiscountPercent%</span>
                                                                    </div>
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div class="mt-auto fw-bold text-danger fs-6">
                                                                    @product.OriginalPrice.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                                                                </div>
                                                            }
                                                        </div>
                                                        <div class="card-footer bg-transparent border-0 text-center pb-2">
                                                            <a asp-page="/Products/ProductDetail" asp-route-slug="@product.UrlSlug" class="btn btn-sm btn-primary">@L["ViewDetails"]</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                            @if (featuredCategory.Products.Count > productsPerSlide) // Only show controls if there's more than one slide
                            {
                                <button class="carousel-control-prev" type="button" data-bs-target="#@carouselId" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">@L["Previous"]</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#@carouselId" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">@L["Next"]</span>
                                </button>
                            }
                        </div>
                    </section>
                }
            }
            else
            {
                <section class="container my-2 bg-light rounded py-3">
                    <div class="alert alert-info">@L["Product:NoFeaturedProductsFound"]</div> @* New localization key *@
                </section>
            }
            @await Component.InvokeAsync(typeof(CategoryListViewComponent))
            @* <vc:category-list /> *@
        </div>
    </div>
</div>