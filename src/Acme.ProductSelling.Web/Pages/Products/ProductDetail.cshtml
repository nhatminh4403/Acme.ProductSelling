@page "/products/{Slug}"
@model Acme.ProductSelling.Web.Pages.Products.ProductDetailModel
@using Acme.ProductSelling.Categories
@using Acme.ProductSelling.Web.Helpers
@using Acme.ProductSelling.Web.Pages.Components.RecentlyViewed
@using Acme.ProductSelling.Web.Pages.Components.RelatedBlogs
@{
    ViewData["Title"] = Model.Product?.ProductName ?? L["Product:ProductDetail"];
    Layout = "/Views/Shared/_Layout.cshtml";

}
@section styles {
    <link href="~/css/global/products/detail.css" rel="stylesheet" />
    <link href="~/css/global/products/recently-viewed.css" rel="stylesheet" />
}
@section scripts {
    @* <script src="~/js/global/cart/add-to-cart-handler.js"></script> *@

    <script>
        $(function () {
            RecentlyViewedManager.trackView('@Model.Product.Id');
        });
    </script>
}


@if (Model.Product != null)
{
    <div class="container mt-4 mb-4">
        <div class="bg-white p-4 rounded">
            <div class="row">
                <div class="col-md-7 text-center">
                    @if (!string.IsNullOrWhiteSpace(Model.Product.ImageUrl))
                    {
                        <img src="@Model.Product.ImageUrl"
                             class="img-fluid rounded border" 
                             loading="lazy" style="max-width: 250px;"
                             alt="@Model.Product.ProductName"
                             onerror="this.onerror=null;this.src='/images/placeholder.png';">
                    }
                    else
                    {
                        <img src="~/images/placeholder.png"                
                             class="product-image"
                             loading="lazy"
                             alt="@Model.Product.ProductName">
                    }
                   
                </div>
                <div class="col-md-5">
                    <h2>@Model.Product.ProductName</h2>
                    <p class="text-muted">@L["Product:Manufacturer"]: @Model.Product.ManufacturerName</p>

                    @if (Model.Product.DiscountPercent > 0)
                    {
                        <h3 class="text-muted text-decoration-line-through my-3">
                            @Model.Product.OriginalPrice.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                        </h3>
                        <h2 class="text-danger my-3">
                            @Model.Product.DiscountedPrice.Value.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                            <span class="badge rounded-pill bg-danger">
                                -@Model.Product.DiscountPercent.ToString("0")%
                            </span>
                        </h2>
                    }
                    else
                    {
                        <h3 class="text-danger my-3">
                            @Model.Product.OriginalPrice.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                        </h3>
                    }

                    <button class="btn btn-primary btn-lg add-to-cart-button"
                            data-product-id="@Model.Product.Id"
                            data-product-name="@Model.Product.ProductName"
                            data-product-price="@(Model.Product.DiscountedPrice ?? Model.Product.OriginalPrice)"
                            @(Model.Product.StockCount <= 0 ? "disabled" : "")>
                        <i class="fas fa-cart-plus me-2"></i>
                        @L[Model.Product.StockCount > 0 ? "Product:AddToCart" : "Product:OutOfStock"]
                    </button>
                </div>
            </div>
        </div>

        <!-- Separator -->
        <div class="row">
            <div class="col">
                <div class="separator-custom rounded"></div>
            </div>
        </div>


        <div class="row">
            <!-- Main content -->
            <div class="col-lg-8">
                <div class="card h-100" id="leftCard">
                    <div class="card-header bg-light"><h2>@L["Product:Specification"]</h2></div>
                    <div class="card-body">
                        <div>
                            @switch (Model.Product.CategorySpecificationType)
                            {
                                // --- Core Components ---
                                case SpecificationType.CPU:
                                    @if (Model.Product.CpuSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_CpuSpecsPartial.cshtml" model="Model.Product.CpuSpecification" />
                                    }
                                    break;
                                case SpecificationType.GPU:
                                    @if (Model.Product.GpuSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_GpuSpecsPartial.cshtml" model="Model.Product.GpuSpecification" />
                                    }
                                    break;
                                case SpecificationType.RAM:
                                    @if (Model.Product.RamSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_RamSpecsPartial.cshtml" model="Model.Product.RamSpecification" />
                                    }
                                    break;
                                case SpecificationType.Motherboard:
                                    @if (Model.Product.MotherboardSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_MotherboardSpecsPartial.cshtml" model="Model.Product.MotherboardSpecification" />
                                    }
                                    break;
                                case SpecificationType.Storage:
                                    @if (Model.Product.StorageSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_StorageSpecsPartial.cshtml" model="Model.Product.StorageSpecification" />
                                    }
                                    break;
                                case SpecificationType.MemoryCard:
                                    @if (Model.Product.MemoryCardSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_MemoryCardSpecsPartial.cshtml" model="Model.Product.MemoryCardSpecification" />
                                    }
                                    break;

                                // --- Cooling & Power ---
                                case SpecificationType.PSU:
                                    @if (Model.Product.PsuSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_PsuSpecsPartial.cshtml" model="Model.Product.PsuSpecification" />
                                    }
                                    break;
                                case SpecificationType.Case:
                                    @if (Model.Product.CaseSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_CaseSpecsPartial.cshtml" model="Model.Product.CaseSpecification" />
                                    }
                                    break;
                                case SpecificationType.CPUCooler:
                                    @if (Model.Product.CpuCoolerSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_CpuCoolerSpecsPartial.cshtml" model="Model.Product.CpuCoolerSpecification" />
                                    }
                                    break;
                                case SpecificationType.CaseFan:
                                    @if (Model.Product.CaseFanSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_CaseFanSpecsPartial.cshtml" model="Model.Product.CaseFanSpecification" />
                                    }
                                    break;

                                // --- Computers ---
                                case SpecificationType.Laptop:
                                    @if (Model.Product.LaptopSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_LaptopSpecsPartial.cshtml" model="Model.Product.LaptopSpecification" />
                                    }
                                    break;
                                case SpecificationType.Handheld:
                                    @if (Model.Product.HandheldSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_HandheldSpecsPartial.cshtml" model="Model.Product.HandheldSpecification" />
                                    }
                                    break;
                                case SpecificationType.Console:
                                    @if (Model.Product.ConsoleSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_ConsoleSpecsPartial.cshtml" model="Model.Product.ConsoleSpecification" />
                                    }
                                    break;

                                // --- Peripherals ---
                                case SpecificationType.Monitor:
                                    @if (Model.Product.MonitorSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_MonitorSpecsPartial.cshtml" model="Model.Product.MonitorSpecification" />
                                    }
                                    break;
                                case SpecificationType.Keyboard:
                                    @if (Model.Product.KeyboardSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_KeyboardSpecsPartial.cshtml" model="Model.Product.KeyboardSpecification" />
                                    }
                                    break;
                                case SpecificationType.Mouse:
                                    @if (Model.Product.MouseSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_MouseSpecsPartial.cshtml" model="Model.Product.MouseSpecification" />
                                    }
                                    break;
                                case SpecificationType.MousePad:
                                    @if (Model.Product.MousepadSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_MousePadSpecsPartial.cshtml" model="Model.Product.MousepadSpecification" />
                                    }
                                    break;

                                // --- Audio & Video ---
                                case SpecificationType.Headset:
                                    @if (Model.Product.HeadsetSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_HeadsetSpecsPartial.cshtml" model="Model.Product.HeadsetSpecification" />
                                    }
                                    break;
                                case SpecificationType.Speaker:
                                    @if (Model.Product.SpeakerSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_SpeakerSpecsPartial.cshtml" model="Model.Product.SpeakerSpecification" />
                                    }
                                    break;
                                case SpecificationType.Microphone:
                                    @if (Model.Product.MicrophoneSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_MicrophoneSpecsPartial.cshtml" model="Model.Product.MicrophoneSpecification" />
                                    }
                                    break;
                                case SpecificationType.Webcam:
                                    @if (Model.Product.WebcamSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_WebcamSpecsPartial.cshtml" model="Model.Product.WebcamSpecification" />
                                    }
                                    break;

                                // --- Furniture ---
                                case SpecificationType.Chair:
                                    @if (Model.Product.ChairSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_ChairSpecsPartial.cshtml" model="Model.Product.ChairSpecification" />
                                    }
                                    break;
                                case SpecificationType.Desk:
                                    @if (Model.Product.DeskSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_DeskSpecsPartial.cshtml" model="Model.Product.DeskSpecification" />
                                    }
                                    break;

                                // --- Networking & Software ---
                                case SpecificationType.NetworkHardware:
                                    @if (Model.Product.NetworkHardwareSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_NetworkHardwareSpecsPartial.cshtml" model="Model.Product.NetworkHardwareSpecification" />
                                    }
                                    break;
                                case SpecificationType.Software:
                                    @if (Model.Product.SoftwareSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_SoftwareSpecsPartial.cshtml" model="Model.Product.SoftwareSpecification" />
                                    }
                                    break;

                                // --- Accessories ---
                                case SpecificationType.Hub:
                                    @if (Model.Product.HubSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_HubSpecsPartial.cshtml" model="Model.Product.HubSpecification" />
                                    }
                                    break;
                                case SpecificationType.Cable:
                                    @if (Model.Product.CableSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_CableSpecsPartial.cshtml" model="Model.Product.CableSpecification" />
                                    }
                                    break;
                                case SpecificationType.Charger:
                                    @if (Model.Product.ChargerSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_ChargerSpecsPartial.cshtml" model="Model.Product.ChargerSpecification" />
                                    }
                                    break;
                                case SpecificationType.PowerBank:
                                    @if (Model.Product.PowerBankSpecification != null)
                                    {
                                        <partial name="~/Pages/Components/ProductSpecs/_PowerBankSpecsPartial.cshtml" model="Model.Product.PowerBankSpecification" />
                                    }
                                    break;

                                // --- Fallback ---
                                default:
                                    <p class="text-muted">@L["Product:NoSpecificSpecifications"]</p>
                                    break;
                            }
                        </div>
                        <hr />

                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="sticky-sidebar" id="rightSidebar">
                    @await Component.InvokeAsync(typeof(RelatedBlogsViewComponent), new {
                    blogs = Model.Blogs?.Items?.ToList(),
                                title = L["UI:Title:RelatedBlogs"].Value,
                                count = 4
                                })
                </div>
            </div>
        </div>

        <!-- Recently Viewed Products -->
        @await Component.InvokeAsync(typeof(RecentlyViewedViewComponent), new {
        maxCount = 6,
        excludeProductId = Model.Product.Id,
        title = L["UI:OtherRecentlyViewed"].Value.ToString(),
        })

    </div>
}
else
{
    <div class="alert alert-warning">@L["Product:ProductNotFound"]</div>
}