@page "/collections/{slug}/price/{PriceRange?}"
@model Acme.ProductSelling.Web.Pages.Products.ProductByPriceModel
@using Acme.ProductSelling.Web.Helpers
@using Acme.ProductSelling.Categories.Configurations
@using Acme.ProductSelling.Web.Pages.Components.PriceFilter

@section styles {
    <link href="~/css/shared/products/product-item.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css">
    <link href="~/css/global/products/priceFilter.css" rel="stylesheet" />

}

@{
    ViewData["Title"] = $"{HelperMethods.GetCategoryLocalizerName(Model.CategoryName, L)} - {Model.DisplayPriceRangeName}";
    Layout = "/Views/Shared/_Layout.cshtml";
}
<div class="container my-2">
    <nav aria-label="breadcrumb" style="--bs-breadcrumb-divider: '>';">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-page="/Index">@L["Menu:Home"]</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">

                @HelperMethods.GetCategoryLocalizerName(Model.CategoryName, L) @Model.DisplayPriceRangeName

            </li>
        </ol>
    </nav>
</div>

<div class="container mb-4 mt-1 py-3 bg-light rounded">
    @* Filter Bar *@
    <div class="filter-bar">
        <button type="button" class="price-filter-button active" id="priceFilterToggle">
            <i class="bi bi-funnel"></i>
            <span>@L["UI:Price"]</span>
            <i class="bi bi-chevron-down ms-1" style="font-size: 12px;"></i>
        </button>
        @* Price Filter Dropdown *@
        <div class="price-dropdown" id="priceDropdown">

            <div id="priceSlider"></div>

            <div class="price-inputs">
                <div class="price-input-wrapper">
                    <input type="text"
                           id="minPriceInput"
                           class="form-control"
                           readonly>
                </div>
                <div class="price-input-wrapper">
                    <input type="text"
                           id="maxPriceInput"
                           class="form-control"
                           readonly>
                </div>
            </div>
            <div class="price-dropdown-footer">
                <button type="button" class="btn-reset" id="resetFilter">
                    <i class="bi bi-arrow-clockwise me-1"></i>@L["Deselect"]
                </button>
                <button type="button" class="btn-apply" id="applyFilter" disabled>
                    @L["UI:ViewResults"]
                </button>
            </div>
        </div>

        @* Backdrop *@
        <div class="dropdown-backdrop" id="dropdownBackdrop"></div>
    </div>

    @* Products Grid *@
    <div id="productsGrid">
        @* Loading Overlay *@
        <div class="loading-overlay">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">@L["Loading"]...</span>
            </div>
        </div>

        @* Products Container *@
        <div id="productsContainer">
            @if (Model.Products != null && Model.Products.Items.Any())
            {
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4">
                    @foreach (var product in Model.Products.Items)
                    {
                        <div class="col">
                            <div class="card product-card shadow-sm h-100">
                                @if (!string.IsNullOrWhiteSpace(product.ImageUrl))
                                {
                                    <a asp-page="/Products/ProductDetail" asp-route-slug="@product.UrlSlug">
                                        <img src="@($"https://placehold.co/200x200?text={product.ProductName.Substring(0, 1)}")"
                                             class="card-img-top p-3"
                                             loading="lazy"
                                             alt="@product.ProductName"
                                             style="max-height: 180px; object-fit: contain;">
                                    </a>
                                }
                                else
                                {
                                    <div class="text-center p-5 bg-light">
                                        <i class="fas fa-image fa-3x text-secondary"></i>
                                    </div>
                                }

                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title mb-2 fs-6" style="min-height: 40px;">
                                    <a asp-page="/Products/ProductDetail"
                                       class="text-decoration-none text-dark"
                                       asp-route-slug="@product.UrlSlug"
                                       title="@product.ProductName">
                                        @(product.ProductName.Length > 50
                                                                            ? product.ProductName.Substring(0, 47) + "..."
                                                                            : product.ProductName)
                                        </a>
                                    </h6>

                                    <div class="mt-auto">
                                        @if (product.DiscountPercent > 0 && product.DiscountedPrice.HasValue)
                                        {
                                            <div class="text-muted text-decoration-line-through small mb-1">
                                                @product.OriginalPrice.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="fw-bold fs-6 text-danger">
                                                    @product.DiscountedPrice.Value.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                                                </span>
                                                <span class="badge bg-danger small">-@product.DiscountPercent%</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="fw-bold text-danger fs-6">
                                                @product.OriginalPrice.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))
                                            </div>
                                        }
                                    </div>
                                </div>

                                <div class="card-footer bg-transparent border-0 text-center pb-2">
                                    <a asp-page="/Products/ProductDetail"
                                       asp-route-slug="@product.UrlSlug"
                                       class="btn btn-sm btn-primary w-100">
                                        @L["ViewDetails"]
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2 fs-4"></i>
                    <div>
                        <h5 class="alert-heading mb-1">@L["Product:NoProductsFound"]</h5>
                        <p class="mb-0">
                            @L["Product:NoProductsFoundInThisPriceRange", Model.DisplayPriceRangeName]
                        </p>
                        <hr class="my-2">
                        <a asp-page="/Products/ProductsByCategory"
                           asp-route-slug="@Model.Slug"
                           class="btn btn-sm btn-outline-primary mt-2">
                            <i class="bi bi-arrow-left me-1"></i>@L["UI:ViewAllProducts"]
                        </a>
                    </div>
                </div>
            }
        </div>

        @* Pagination *@
        <div id="paginationContainer" class="mt-4">
            @if (Model.Products.TotalCount > Model.PageSize)
            {
                <abp-paginator model="Model.PagerModel"></abp-paginator>
            }
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
    <script>
        (function() {
            const categorySlug = '@Model.Slug';
            const priceRange = '@Model.PriceRange';

            // EXACT bounds from the selected price range
            const rangeMin = @Model.MinPrice;
            const rangeMax = @(CategoryPriceRangeConfiguration.IsOpenEndedRange(Model.MaxPrice) ? Model.ActualMaxPrice : Model.MaxPrice);

            let priceSlider;
            let currentPage = 1;
            const pageSize = @Model.PageSize;
            let hasChanges = false;
            let sliderTouched = false;
            const dropdown = document.getElementById('priceDropdown');
            const toggleBtn = document.getElementById('priceFilterToggle');
            const backdrop = document.getElementById('dropdownBackdrop');
            const resetBtn = document.getElementById('resetFilter');
            const applyBtn = document.getElementById('applyFilter');

            console.log('Price Slider Configuration:', {
                priceRange: priceRange,
                exactRangeBounds: [rangeMin, rangeMax]
            });

            // Initialize price slider
            function initPriceSlider() {
                const sliderElement = document.getElementById('priceSlider');

                if (!sliderElement) {
                    console.error('Slider element not found');
                    return;
                }

                priceSlider = noUiSlider.create(sliderElement, {
                    start: [rangeMin, rangeMax],
                    connect: true,
                    range: {
                        'min': rangeMin,
                        'max': rangeMax
                    },
                    step: getStep(rangeMax - rangeMin),
                    format: {
                        to: function(value) {
                            return Math.round(value);
                        },
                        from: function(value) {
                            return Number(value);
                        }
                    }
                });

                // Update input fields and detect changes
                priceSlider.on('update', function(values, handle) {
                    const minInput = document.getElementById('minPriceInput');
                    const maxInput = document.getElementById('maxPriceInput');

                    minInput.value = formatPriceNumber(values[0]);
                    maxInput.value = formatPriceNumber(values[1]);

                    // Check if values have changed from initial
                    const currentMin = Math.round(parseFloat(values[0]));
                    const currentMax = Math.round(parseFloat(values[1]));
                    hasChanges = currentMin !== rangeMin || currentMax !== rangeMax;

                     if (sliderTouched) {
                                applyBtn.disabled = false;
                            }
                        });
                 priceSlider.on('start', function() {
                    sliderTouched = true;
                });
            }

            // Get appropriate step based on price range
            function getStep(range) {
                if (range >= 50000000) return 1000000;  // 1M steps
                if (range >= 10000000) return 500000;   // 500K steps
                if (range >= 5000000) return 250000;    // 250K steps
                if (range >= 2000000) return 100000;    // 100K steps
                if (range >= 1000000) return 50000;     // 50K steps
                return 10000; // 10K steps for small ranges
            }

            // Format price as full number with thousand separators
            function formatPriceNumber(value) {
                const num = Math.round(Number(value));
                return new Intl.NumberFormat('vi-VN').format(num) + 'đ';
            }

            // Toggle dropdown
            toggleBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const isOpen = dropdown.classList.contains('show');

                if (isOpen) {
                    closeDropdown();
                } else {
                    openDropdown();
                }
            });

            function openDropdown() {
                dropdown.classList.add('show');
                backdrop.classList.add('show');
                hasChanges = false;
                applyBtn.disabled = true;
                if (priceSlider) {
                    priceSlider.set([rangeMin, rangeMax]);
                }
            }

            function closeDropdown() {
                dropdown.classList.remove('show');
                backdrop.classList.remove('show');
                hasChanges = false;
                applyBtn.disabled = true;
                if (priceSlider) {
                    priceSlider.set([rangeMin, rangeMax]);
                }
            }

            // Close dropdown when clicking backdrop
            backdrop.addEventListener('click', closeDropdown);

            // Reset button
            resetBtn.addEventListener('click', function() {
                if (priceSlider) {
                    priceSlider.set([rangeMin, rangeMax]);
                }
            });

            // Apply filter
            applyBtn.addEventListener('click', function() {
                if (!hasChanges) return;

                const values = priceSlider.get();
                loadProducts(values[0], values[1], 1);
                closeDropdown();
            });

            // Load products via AJAX
            function loadProducts(minPrice, maxPrice, page = 1) {
                const overlay = document.querySelector('.loading-overlay');
                overlay.classList.add('active');

                const url = `/api/products/filter-by-price?categorySlug=${categorySlug}&minPrice=${minPrice}&maxPrice=${maxPrice}&page=${page}&pageSize=${pageSize}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateProductsGrid(data.data);
                            updateCurrentRangeDisplay(minPrice, maxPrice);
                            updatePagination(data.totalPages, data.currentPage);
                            currentPage = data.currentPage;
                        } else {
                            showError(data.error || 'Failed to load products');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading products:', error);
                        showError('An error occurred while loading products');
                    })
                    .finally(() => {
                        overlay.classList.remove('active');
                    });
            }

            // Update current range display
            function updateCurrentRangeDisplay(minPrice, maxPrice) {
                const minFormatted = formatPriceNumber(minPrice);
                const maxFormatted = formatPriceNumber(maxPrice);
                const rangeText = `${minFormatted} - ${maxFormatted}`;
            }

            // Update products grid HTML
            function updateProductsGrid(products) {
                const container = document.getElementById('productsContainer');

                if (products.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="bi bi-info-circle me-2 fs-4"></i>
                            <div>
                                <h5 class="alert-heading mb-1">@L["Product:NoProductsFound"]</h5>
                                <p class="mb-0">@L["Product:TryAdjustingPriceRange"]</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                        let html = '<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4">';
                products.forEach(product => {
                    html += renderProductCard(product);
                });
                html += '</div>';

                container.innerHTML = html;
            }

            // Render single product card
            function renderProductCard(product) {
                const price = product.discountedPrice || product.originalPrice;
                const formattedPrice = new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(price);

                const originalPriceFormatted = new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(product.originalPrice);

                return `
                    <div class="col">
                        <div class="card product-card h-100 shadow-sm">
                            <a href="/products/${product.urlSlug}">
                                <img src="https://placehold.co/200x200?text=${product.productName.charAt(0)}"
                                     class="card-img-top p-3"
                                     alt="${product.productName}"
                                     style="max-height: 180px; object-fit: contain;">
                            </a>
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title mb-2" style="min-height: 40px;">
                                    <a href="/products/${product.urlSlug}" class="text-decoration-none text-dark">
                                        ${product.productName.length > 50 ? product.productName.substring(0, 47) + '...' : product.productName}
                                    </a>
                                </h6>
                                <div class="mt-auto">
                                    ${product.discountPercent > 0 && product.discountedPrice ? `
                                        <div class="text-muted text-decoration-line-through small mb-1">
                                            ${originalPriceFormatted}
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="fw-bold text-danger fs-6">${formattedPrice}</span>
                                            <span class="badge bg-danger small">-${product.discountPercent}%</span>
                                        </div>
                                    ` : `
                                        <div class="fw-bold text-danger fs-6">${formattedPrice}</div>
                                    `}
                                </div>
                            </div>
                            <div class="card-footer bg-transparent border-0 text-center pb-2">
                                <a href="/products/${product.urlSlug}" class="btn btn-sm btn-primary w-100">
                                   @L["ViewDetails"]
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }


            // Update pagination
            function updatePagination(totalPages, currentPage) {
                const container = document.getElementById('paginationContainer');
                if (totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                let html = '<nav><ul class="pagination justify-content-center">';

                html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">@L["Previous"]</a>
                </li>`;

                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>`;
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                    }
                }

                html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">@L["Next"]</a>
                </li>`;

                html += '</ul></nav>';
                container.innerHTML = html;

                container.querySelectorAll('.page-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (!this.parentElement.classList.contains('disabled') &&
                            !this.parentElement.classList.contains('active')) {
                            const page = parseInt(this.dataset.page);
                            const values = priceSlider.get();
                            loadProducts(values[0], values[1], page);
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                });
            }

            // Show error message
            function showError(message) {
                const container = document.getElementById('productsContainer');
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>${message}
                    </div>
                `;
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function() {
                initPriceSlider();
            });
        })();
    </script>
}
